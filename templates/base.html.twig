<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Welcome!{% endblock %}</title>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text></svg>">
    {% block stylesheets %}
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="{{ asset('css/style.css') }}"/>
    {% endblock %}


</head>
<body>
{% block body %}
    <script src="//code.iconify.design/1/1.0.6/iconify.min.js"></script>
    <nav id="top-menu">
        <div id="top-menu-options">
            <div id="top-menu-option">
                <a href="{{ path('app_catalogs_home') }}">Strona główna</a>
            </div>
            {% if not is_granted('ROLE_GOD') %}
                <div id="top-menu-option">
                    <a href="{{ path('app_add_report') }}">Wyślij zgłoszenie</a> -
                </div>
            {% endif %}
            {% if is_granted('ROLE_EDITOR') %}
                <div id="top-menu-option">
                    <a href="{{ path('app_show_report') }}">Zgłoszenia</a>
                    <span id="report-notification-count">

                    </span>
                </div>
            {% endif %}
            {% if is_granted('ROLE_ADMIN') %}
                <div id="top-menu-option">
                    <a href="{{ path('app_manage_users') }}">Użytkownicy</a>
                </div>
                <div id="top-menu-option">
                    <a href="{{ path('app_show_system') }}">Systemodawcy</a>
                </div>
                <div id="top-menu-option">
                    <a href="{{ path('app_log') }}">Dziennik</a>
                </div>
            {% endif %}
            {% if is_granted('ROLE_GOD') %}
                <div id="top-menu-option">
                    <a href="{{ path('app_manage_requests') }}">Prośby o rejestrację</a>
                    <span id="request-notification-count">

                    </span>
                </div>
                <div id="top-menu-option">
                    <a href="{{ path('app_show_report_category') }}">Kategorie zgłoszeń</a>
                </div>
            {% endif %}
        </div>
        <div id="top-menu-options">
            <div id="user-info">
                <span class="user-element">{{ app.user.email }}</span>
                <span class="user-element"><a href="{{ path('app_logout') }}">Wyloguj</a></span>
                <span></span>
            </div>
        </div>

    </nav>
    <span class="ok-message-element" id="ok-message-element">
        {% if app.session.flashBag.has('success') %}
        {{ app.session.flashBag.get('success')[0] }}
        <span id="close-message-icon">
            <span class="iconify" data-icon="mdi-close"></span>
        </span>
        {% endif %}
    </span>

{% endblock %}
{% block javascripts %}
    <script>
        let message = "Usunięcie spowoduje bezpowrotne skasowanie wszystkich danych. Czy chcesz kontynuować?";

        function confirmDelete(id, entity) {
            if (window.confirm("Czy na pewno chcesz usunąć ten element? Tej operacji nie można cofnąć.")) {
                window.location.href = `/${entity}/delete/${id}`;
            }
        }
    </script>
    <script>
        let closeMessageEl = document.getElementById("close-message-icon");
        let okMessageEl=document.getElementById("ok-message-element");
        closeMessageEl?.addEventListener('click', (event) => {
            okMessageEl.innerText = null;
            event.preventDefault();
        });
    </script>
    <script>
        const reportNotificationCountEl = document.getElementById("report-notification-count");
        const requestNotificationCountEl = document.getElementById("request-notification-count");
        (async () => {
            const notifications = await fetchData();

            if(requestNotificationCountEl) {
                if (notifications.numberOfRegisterRequests != null) {
                    requestNotificationCountEl.style.display = 'flex;'
                    requestNotificationCountEl.innerText = notifications.numberOfRegisterRequests;
                } else {
                    requestNotificationCountEl.style.display = 'none';
                    requestNotificationCountEl.innerText = null;
                }
            }

            if(reportNotificationCountEl) {
                if (notifications.numberOfReports != null) {
                    reportNotificationCountEl.style.display = 'flex';
                    reportNotificationCountEl.innerText = notifications.numberOfReports;
                } else {
                    reportNotificationCountEl.style.display = 'none';
                    reportNotificationCountEl.innerText = null;
                }
            }


        })();

        async function fetchData() {
            try {
                const response = await fetch('/get-notifications', {
                    method: 'POST'
                });

                const data = await response.json();
                console.log(data.numberOfReports);
                return {
                    numberOfRegisterRequests: Number(data.numberOfRegisterRequests),
                    numberOfReports: Number(data.numberOfReports)
                }
            } catch (error) {
                console.error("Błąd:", error);
            }
        } //TODO FIX IT
    </script>
{% endblock %}
</body>
</html>
